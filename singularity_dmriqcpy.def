BootStrap: docker
From: ubuntu:bionic

%setup
    export IMK_MESA=mesa-11.0.7.tar.gz
    export IMK_VTK=VTK-8.2.0.tar.gz

    rm -rf $SINGULARITY_ROOTFS/VTK-src
    rm -rf $SINGULARITY_ROOTFS/VTK-build
    rm -rf $SINGULARITY_ROOTFS/mesa-src

    mkdir $SINGULARITY_ROOTFS/VTK-src
    mkdir $SINGULARITY_ROOTFS/VTK-build
    mkdir $SINGULARITY_ROOTFS/mesa-src

    cp $IMK_VTK $SINGULARITY_ROOTFS/VTK-src
    cp $IMK_MESA $SINGULARITY_ROOTFS/mesa-src

    cd $SINGULARITY_ROOTFS/VTK-src
    tar zxvf $IMK_VTK
    rm $IMK_VTK

    cd $SINGULARITY_ROOTFS/mesa-src
    tar zxvf $IMK_MESA
    rm $IMK_MESA

%post
    sed -i 's/main/main restricted universe/g' /etc/apt/sources.list
    apt-get update && apt-get -y upgrade
    DEBIAN_FRONTEND=noninteractive apt-get -y install build-essential git python3-dev python3-pip python3-tk python3-lxml python3-six cmake libtool autoconf pkg-config

    pip3 install -U pip==9.0.1
    export PATH=/usr/local/bin/:$PATH
    export PYTHON_INCLUDE_DIR=/usr/include/python3.5
    export PYTHON_LIBRARY=usr/lib/python3.5/config-3.5m-x86_64-linux-gnu/libpython3.5.so
    pip3 install -U setuptools

    cd /mesa-src/mesa*
    autoreconf -fi
    ./configure CXXFLAGS="-O2 -g -DDEFAULT_SOFTWARE_DEPTH_BITS=31" CFLAGS="-O2 -g -DDEFAULT_SOFTWARE_DEPTH_BITS=31"--disable-xvmc --disable-dri --with-dri-drivers="" --with-gallium-drivers="swrast" --enable-texture-float --disable-egl --with-egl-platforms="" --enable-gallium-osmesa --enable-gallium-llvm=yes --with-llvm-shared-libs --prefix=/usr/
    make -j
    make install

    cd /VTK-build
    cmake -DCMAKE_BUILD_TYPE=Release -DVTK_WRAP_PYTHON=ON -DVTK_USE_X=OFF -DBUILD_SHARED_LIBS=ON -DVTK_OPENGL_HAS_OSMESA=ON -DVTK_USE_OFFSCREEN=ON -DOPENGL_gl_LIBRARY=/usr/lib/libglapi.so -DOSMESA_INCLUDE_DIR=/usr/include/ -DOSMESA_LIBRARY=/usr/lib/libOSMesa.so -DCMAKE_INSTALL_PREFIX=/usr/ ../VTK-src/VTK*
    make -j 8
    make install

    pip3 install git+https://github.com/GuillaumeTh/dmriqcpy.git

    # Use offscreen backend
    echo "backend : Agg" > /usr/local/lib/python3.6/dist-packages/matplotlib/mpl-data/matplotlibrc
